// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER - Authentication & account management
// ============================================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String // bcrypt hash
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  inventory InventoryItem[]
  orders    Order[]
}

// ============================================
// INVENTORY ITEM - Core business entity
// ============================================
model InventoryItem {
  id String @id @default(uuid())

  // Business fields (from assessment)
  merchantId    String // External merchant reference
  sku           String // Stock keeping unit
  title         String
  brand         String? // Optional
  category      String
  condition     ItemCondition
  originalPrice Float // Must be > 0
  currency      String        @default("ZAR")
  quantity      Int           @default(1) // Must be >= 1

  // Pricing & status
  resalePrice Float? // Null until priced
  status      ItemStatus @default(DRAFT)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  // Constraints: unique (userId, merchantId, sku)
  @@unique([userId, merchantId, sku])
  @@index([userId])
  @@index([status])
  @@index([category])
}

// ============================================
// ENUMS
// ============================================
enum ItemCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
}

enum ItemStatus {
  DRAFT // Just created, not priced
  PRICED // Has resale price
  LISTED // Published to marketplace
}


model Order {
  id          String      @id @default(uuid())
  orderNumber String      @unique // Human-readable: ORD-20260201143000001

  // Buyer reference
  buyerId String
  buyer   User   @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  // Pricing snapshot (frozen at order time)
  subtotal       Float
  discountCode   String?
  discountAmount Float   @default(0)
  total          Float
  currency       String  @default("ZAR")

  // Status tracking
  status        OrderStatus @default(PENDING)
  statusHistory Json        @default("[]") // [{status, timestamp, note}]

  // Payment info (mocked)
  paymentAuthId String?
  paymentMethod String?

  // Fulfillment tracking
  fulfilledAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items OrderItem[]

  @@index([buyerId])
  @@index([status])
}

// ============================================
// ORDER ITEM - Individual items in an order
// ============================================
model OrderItem {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Product reference
  productId String
  product   InventoryItem @relation(fields: [productId], references: [id])

  // Snapshot at order time (prices can change later, so we freeze them)
  productTitle String
  productBrand String?
  unitPrice    Float // resalePrice at order time
  quantity     Int
  lineTotal    Float // unitPrice Ã— quantity

  @@index([orderId])
}

// ============================================
// ORDER STATUS ENUM
// ============================================
enum OrderStatus {
  PENDING             // Step 1: Order just created
  INVENTORY_RESERVED  // Step 2: Stock reserved
  PAYMENT_PENDING     // Step 3: Price validated, awaiting payment
  PAYMENT_AUTHORIZED  // Step 4: Payment approved
  CONFIRMED           // Step 5: Order confirmed
  FULFILLED           // Step 6-7: Inventory deducted & ready for delivery
  CANCELLED           // Order cancelled at any step
}