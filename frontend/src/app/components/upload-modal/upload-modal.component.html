<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" (click)="close.emit()">
  <div class="card w-full max-w-lg mx-4" (click)="$event.stopPropagation()">
    <div class="flex items-center justify-between p-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold">
        <i class="fa-solid fa-upload text-blue-600 mr-2"></i> Bulk Upload
      </h2>
      <button (click)="close.emit()" class="p-1 hover:bg-gray-100 rounded">
        <i class="fa-solid fa-xmark text-gray-500"></i>
      </button>
    </div>

    <div class="p-4">
      @if (!result()) {
        <!-- Upload Area -->
        <div
          class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer"
          [class.border-blue-400]="isDragging"
          [class.bg-blue-50]="isDragging"
          (dragover)="onDragOver($event)"
          (dragleave)="isDragging = false"
          (drop)="onDrop($event)"
          (click)="fileInput.click()"
        >
          <input
            #fileInput
            type="file"
            accept=".csv"
            class="hidden"
            (change)="onFileSelect($event)"
          />
          <i class="fa-solid fa-folder-open fa-3x text-gray-400"></i>
          <p class="mt-2 text-gray-600">Drag & drop CSV file here</p>
          <p class="text-sm text-gray-400">or click to browse</p>
        </div>

        @if (selectedFile()) {
          <div class="mt-4 flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
            <i class="fa-solid fa-file-csv text-green-600 fa-lg"></i>
            <div class="flex-1">
              <p class="text-sm font-medium">{{ selectedFile()?.name }}</p>
              <p class="text-xs text-gray-500">{{ formatSize(selectedFile()?.size || 0) }}</p>
            </div>
            <button (click)="clearFile($event)" class="p-1 hover:bg-gray-200 rounded">
              <i class="fa-solid fa-xmark text-gray-500"></i>
            </button>
          </div>
        }

        @if (error()) {
          <div class="mt-4 bg-red-50 text-red-700 px-4 py-3 rounded-lg text-sm flex items-center gap-2">
            <i class="fa-solid fa-circle-exclamation"></i>
            {{ error() }}
          </div>
        }

        <div class="flex justify-end gap-3 mt-6">
          <button type="button" (click)="close.emit()" class="btn btn-secondary">Cancel</button>
          <button
            type="button"
            (click)="upload()"
            class="btn btn-primary"
            [disabled]="!selectedFile() || loading()"
          >
            @if (loading()) {
              <i class="fa-solid fa-spinner fa-spin"></i> Uploading...
            } @else {
              <i class="fa-solid fa-upload"></i> Upload
            }
          </button>
        </div>
      } @else {
        <!-- Results Modal -->
        <div class="space-y-4">
          <!-- Success Summary -->
          @if (result()!.summary!.inserted > 0) {
            <div class="flex items-center gap-3 p-4 bg-green-50 rounded-lg border border-green-200">
              <i class="fa-solid fa-circle-check fa-2x text-green-600"></i>
              <div>
                <p class="font-semibold text-green-800">
                  {{ result()!.summary!.inserted }} {{ result()!.summary!.inserted === 1 ? 'row' : 'rows' }} successfully loaded
                </p>
                <p class="text-sm text-green-600">Items have been added to your inventory as drafts</p>
              </div>
            </div>
          }

          <!-- Error Summary -->
          @if (getTotalErrors() > 0) {
            <div class="p-4 bg-red-50 rounded-lg border border-red-200">
              <div class="flex items-center gap-3 mb-3">
                <i class="fa-solid fa-triangle-exclamation fa-2x text-red-600"></i>
                <div>
                  <p class="font-semibold text-red-800">
                    {{ getTotalErrors() }} {{ getTotalErrors() === 1 ? 'row' : 'rows' }} could not be loaded
                  </p>
                  <p class="text-sm text-red-600">Please review the errors below and fix your CSV file</p>
                </div>
              </div>
              
              <!-- Error Details Table -->
              <div class="max-h-48 overflow-y-auto bg-white rounded border border-red-100">
                <table class="w-full text-sm">
                  <thead class="bg-red-100 sticky top-0">
                    <tr>
                      <th class="px-3 py-2 text-left text-red-800 font-medium w-16">Row</th>
                      <th class="px-3 py-2 text-left text-red-800 font-medium">Error Details</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-red-100">
                    @for (err of getAllErrors(); track err.rowNumber) {
                      <tr class="hover:bg-red-50">
                        <td class="px-3 py-2 text-gray-700 font-medium">{{ err.rowNumber }}</td>
                        <td class="px-3 py-2 text-red-700">
                          @for (e of err.errors; track e; let last = $last) {
                            <span>{{ e }}</span>@if (!last) {<span>, </span>}
                          }
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          }

          <!-- All Failed -->
          @if (result()!.summary!.inserted === 0 && getTotalErrors() > 0) {
            <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200 text-center">
              <p class="text-sm text-yellow-800">
                <i class="fa-solid fa-lightbulb mr-1"></i>
                <strong>Tip:</strong> Check that your CSV has all required columns: 
                merchant_id, sku, title, category, condition, original_price, currency, quantity
              </p>
            </div>
          }

          <!-- All Success -->
          @if (result()!.summary!.inserted > 0 && getTotalErrors() === 0) {
            <div class="p-3 bg-blue-50 rounded-lg border border-blue-200 text-center">
              <p class="text-sm text-blue-800">
                <i class="fa-solid fa-party-horn mr-1"></i> Perfect! All rows were processed successfully
              </p>
            </div>
          }

          <div class="flex justify-end pt-2">
            <button type="button" (click)="onDone()" class="btn btn-primary">
              <i class="fa-solid fa-check"></i> Done
            </button>
          </div>
        </div>
      }
    </div>
  </div>
</div>
